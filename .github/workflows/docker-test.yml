name: Docker Test

on:
  push:
    branches: [ "main" ]
    paths: 
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Free up disk space
      run: |
        docker system prune -af
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: Create .env file for testing
      run: |
        cd ch7
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
        ELASTICSEARCH_HOST=http://elasticsearch:9200
        ELASTICSEARCH_INDEX=documents
        API_HOST=0.0.0.0
        API_PORT=8000
        EOF
        
    - name: Build and start services
      run: |
        cd ch7
        # Build with cache to save space and time
        docker compose build
        # Start only essential services for basic testing
        docker compose up -d elasticsearch
        # Wait a bit for Elasticsearch to start
        sleep 30
        
    - name: Test Elasticsearch health
      run: |
        cd ch7
        echo "Testing Elasticsearch health..."
        timeout=120
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f http://localhost:9200/_cat/health > /dev/null 2>&1; then
            echo "Elasticsearch is healthy!"
            break
          fi
          echo "Waiting for Elasticsearch... ($counter/$timeout)"
          sleep 5
          counter=$((counter + 5))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "Elasticsearch failed to become healthy"
          docker compose logs elasticsearch
          exit 1
        fi
        
    - name: Test Docker images can be built and run
      run: |
        cd ch7
        echo "Testing Docker build and service startup..."
        
        # Test that we can run the API service independently (bypass indexing dependency)
        echo "Starting API service without indexing dependency..."
        docker compose run --rm --no-deps -p 8000:8000 -d --name test-api api &
        API_PID=$!
        sleep 20
        
        # Check if the API container is running
        if docker ps | grep -q "test-api"; then
          echo "✅ API container started successfully!"
          
          # Test basic connectivity (may not be fully functional without indexing)
          if docker exec test-api curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "✅ API health endpoint is accessible!"
          else
            echo "⚠️  API started but health endpoint not ready (expected without indexing)"
          fi
        else
          echo "❌ API container failed to start"
          docker logs test-api || true
          exit 1
        fi
        
        # Clean up the test container
        docker stop test-api || true
        docker rm test-api || true
        
        echo "✅ Docker build and basic service tests completed successfully!"
        
    - name: Show logs on failure
      if: failure()
      run: |
        cd ch7
        echo "=== Docker compose ps ==="
        docker compose ps || true
        echo "=== Service logs ==="
        docker compose logs || true
        
    - name: Cleanup
      if: always()
      run: |
        cd ch7
        docker compose down -v
        docker system prune -f