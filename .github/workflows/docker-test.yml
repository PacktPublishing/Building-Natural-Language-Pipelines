name: Docker Test

on:
  push:
    branches: [ "main" ]
    paths: 
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Free up disk space
      run: |
        docker system prune -af
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: Create .env file for testing
      run: |
        cd ch7
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
        ELASTICSEARCH_HOST=http://elasticsearch:9200
        ELASTICSEARCH_INDEX=documents
        API_HOST=0.0.0.0
        API_PORT=8000
        EOF
        
    - name: Build and start services
      run: |
        cd ch7
        # Build with cache to save space and time
        docker compose build
        # Start only essential services for basic testing
        docker compose up -d elasticsearch
        # Wait a bit for Elasticsearch to start
        sleep 30
        
    - name: Test Elasticsearch health
      run: |
        cd ch7
        echo "Testing Elasticsearch health..."
        timeout=120
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f http://localhost:9200/_cat/health > /dev/null 2>&1; then
            echo "Elasticsearch is healthy!"
            break
          fi
          echo "Waiting for Elasticsearch... ($counter/$timeout)"
          sleep 5
          counter=$((counter + 5))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "Elasticsearch failed to become healthy"
          docker compose logs elasticsearch
          exit 1
        fi
        
    - name: Test Docker image can start API service
      run: |
        cd ch7
        echo "Testing if API service can start..."
        # Start the API service briefly to test it can run
        docker compose up -d api
        sleep 15
        
        # Check if container started successfully
        if docker compose ps api | grep -q "Up"; then
          echo "API service started successfully!"
        else
          echo "API service failed to start"
          docker compose logs api
          exit 1
        fi
        
    - name: Show logs on failure
      if: failure()
      run: |
        cd ch7
        echo "=== Docker compose ps ==="
        docker compose ps || true
        echo "=== Service logs ==="
        docker compose logs || true
        
    - name: Cleanup
      if: always()
      run: |
        cd ch7
        docker compose down -v
        docker system prune -f