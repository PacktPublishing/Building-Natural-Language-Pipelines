name: Docker Test

on:
  push:
    branches: [ "main" ]
    paths: 
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'ch7/**'
      - '.github/workflows/docker-test.yml'

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create .env file for testing
      run: |
        cd ch7
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
        ELASTICSEARCH_HOST=http://elasticsearch:9200
        ELASTICSEARCH_INDEX=documents
        API_HOST=0.0.0.0
        API_PORT=8000
        EOF
        
    - name: Build Docker images
      run: |
        cd ch7
        docker compose build --no-cache
        
    - name: Start services
      run: |
        cd ch7
        docker compose up -d
        
    - name: Wait for Elasticsearch to be healthy
      run: |
        cd ch7
        timeout=300
        counter=0
        echo "Waiting for Elasticsearch to be healthy..."
        while [ $counter -lt $timeout ]; do
          if docker compose exec -T elasticsearch curl -f http://localhost:9200/_cat/health > /dev/null 2>&1; then
            echo "Elasticsearch is healthy!"
            break
          fi
          echo "Waiting for Elasticsearch... ($counter/$timeout)"
          sleep 5
          counter=$((counter + 5))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "Elasticsearch failed to become healthy within $timeout seconds"
          docker compose logs elasticsearch
          exit 1
        fi
        
    - name: Wait for indexing to complete
      run: |
        cd ch7
        timeout=600
        counter=0
        echo "Waiting for indexing service to complete..."
        while [ $counter -lt $timeout ]; do
          status=$(docker compose ps indexing --format "table {{.State}}" | tail -n +2)
          if echo "$status" | grep -q "Exited (0)"; then
            echo "Indexing completed successfully!"
            break
          elif echo "$status" | grep -q "Exited"; then
            echo "Indexing failed!"
            docker compose logs indexing
            exit 1
          fi
          echo "Waiting for indexing to complete... ($counter/$timeout)"
          sleep 10
          counter=$((counter + 10))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "Indexing failed to complete within $timeout seconds"
          docker compose logs indexing
          exit 1
        fi
        
    - name: Wait for API to be healthy
      run: |
        cd ch7
        timeout=300
        counter=0
        echo "Waiting for API to be healthy..."
        while [ $counter -lt $timeout ]; do
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "API is healthy!"
            break
          fi
          echo "Waiting for API... ($counter/$timeout)"
          sleep 5
          counter=$((counter + 5))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "API failed to become healthy within $timeout seconds"
          docker compose logs api
          exit 1
        fi
        
    - name: Test API endpoints
      run: |
        cd ch7
        echo "Testing health endpoint..."
        health_response=$(curl -s http://localhost:8000/health)
        echo "Health response: $health_response"
        
        echo "Testing root endpoint..."
        root_response=$(curl -s http://localhost:8000/)
        echo "Root response: $root_response"
        
        # Test if health endpoint returns expected structure
        if echo "$health_response" | grep -q '"status"'; then
          echo "Health endpoint test passed!"
        else
          echo "Health endpoint test failed!"
          exit 1
        fi
        
    - name: Test basic query functionality (if API key available)
      if: env.OPENAI_API_KEY != ''
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd ch7
        echo "Testing basic query functionality..."
        query_response=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{"query": "What is machine learning?"}' \
          http://localhost:8000/query)
        
        echo "Query response: $query_response"
        
        # Check if we get a proper response structure
        if echo "$query_response" | grep -q '"answer"'; then
          echo "Query functionality test passed!"
        else
          echo "Query functionality test failed, but continuing..."
          echo "This might be expected if no documents are indexed or API keys are missing"
        fi
        
    - name: Show service logs on failure
      if: failure()
      run: |
        cd ch7
        echo "=== Elasticsearch logs ==="
        docker compose logs elasticsearch || true
        echo "=== Indexing logs ==="
        docker compose logs indexing || true
        echo "=== API logs ==="
        docker compose logs api || true
        echo "=== Docker compose ps ==="
        docker compose ps || true
        
    - name: Cleanup
      if: always()
      run: |
        cd ch7
        docker compose down -v
        docker system prune -f